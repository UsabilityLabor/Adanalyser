<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of AnalyseAction</title>
  <meta name="keywords" content="AnalyseAction">
  <meta name="description" content="Performs analysis steps for valid subjects">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html &copy; 2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../m2html.css">
  <script type="text/javascript">
    if (top.frames.length == 0) { top.location = "../index.html"; };
  </script>
</head>
<body>
<a name="_top"></a>
<!-- menu.html AdAnalyzerSoftware -->
<h1>AnalyseAction
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>Performs analysis steps for valid subjects</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>This is a script file. </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre class="comment"> Performs analysis steps for valid subjects
   Starts when button &quot;Analyse&quot; was clicked
   Performs eeg frequency analysis
   Calculates statistics
   Plots 2D Topology Maps with video
   Plots 2D Topology Overview chart
   Plots eda figures, eeg frequency figures
   Calculates statistics

 Author: Gernot Heisenberg, Tim Kreitzberg</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="AnalyseAction.html" class="code" title="">AnalyseAction</a>	Performs analysis steps for valid subjects</li><li><a href="Plotter.html" class="code" title="">Plotter</a>	Performs different plots</li><li><a href="StringStatistics.html" class="code" title="">StringStatistics</a>	Utility class to cast statistic values to String and format them for print output.</li></ul>
This function is called by:
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="AnalyseAction.html" class="code" title="">AnalyseAction</a>	Performs analysis steps for valid subjects</li></ul>
<!-- crossreference -->

<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="#_sub1" class="code">function analyse(self,data,config,eegDevice,edaDevice,hrvDevice)</a></li><li><a href="#_sub2" class="code">function numValidSubjects = countValidSubjects(self,subjects)</a></li><li><a href="#_sub3" class="code">function subjectValid(self,subject,config)</a></li><li><a href="#_sub4" class="code">function analyseSubject(self,subject,StimuIntDefs,config,eegDevice,edaDevice,hrvDevice)</a></li><li><a href="#_sub5" class="code">function meanEEGPerStim = calculateMeanEEGValuesForStimuInt(self,subject)</a></li><li><a href="#_sub6" class="code">function StimuIntStatsMat = analyseStimuInt(self,subject,StimuIntNumber,filteredEEGPerStim,edaPerVid,StimuIntDefs,config,eegDevice,edaDevice,hrvDevice)</a></li><li><a href="#_sub7" class="code">function [m,sd,devP,devM] = calculateStatistics(self,values)</a></li><li><a href="#_sub8" class="code">function statsMat = calculateEEGFrequencyStatistics(self,eeg,delta,theta,alpha,beta1,beta2,task)</a></li><li><a href="#_sub9" class="code">function statsMat = calculateEDAStatistics(self,StimuInt,edaValues,delays,amplitudes,StimuIntDefs)</a></li><li><a href="#_sub10" class="code">function [values,delays] = calculateDelaysEDA(self,edaValues,intervals,edaDevice)</a></li><li><a href="#_sub11" class="code">function [delta,theta,alpha,beta1,beta2,task] = analyseFrequencies(self,filteredEEGData,eegDevice)</a></li><li><a href="#_sub12" class="code">function [delta_s,theta_s,alpha_s,beta1_s,beta2_s,task_s] = reduceTo4Hz(self,delta,theta,alpha,beta1,beta2,task,eegDevice)</a></li><li><a href="#_sub13" class="code">function indicies = getStimuIntIndex(self,SearchType,StimuIntDef)</a></li></ul>

<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre>0001 <span class="comment">% Performs analysis steps for valid subjects</span>
0002 <span class="comment">%   Starts when button &quot;Analyse&quot; was clicked</span>
0003 <span class="comment">%   Performs eeg frequency analysis</span>
0004 <span class="comment">%   Calculates statistics</span>
0005 <span class="comment">%   Plots 2D Topology Maps with video</span>
0006 <span class="comment">%   Plots 2D Topology Overview chart</span>
0007 <span class="comment">%   Plots eda figures, eeg frequency figures</span>
0008 <span class="comment">%   Calculates statistics</span>
0009 <span class="comment">%</span>
0010 <span class="comment">% Author: Gernot Heisenberg, Tim Kreitzberg</span>
0011 <span class="comment">%</span>
0012 classdef <a href="AnalyseAction.html" class="code" title="">AnalyseAction</a> &lt; handle
0013     
0014     properties
0015         plotter = <a href="Plotter.html" class="code" title="">Plotter</a>;
0016         stringStatistics = <a href="StringStatistics.html" class="code" title="">StringStatistics</a>;
0017         frequencies;
0018         frequencies4Hz;
0019     <span class="keyword">end</span>
0020     
0021     methods
0022         <span class="comment">%% Main function of this class</span>
0023         <span class="comment">%   Performs &quot;Analyse&quot; calculation step for all valid subjects</span>
0024         <span class="comment">%   and initialize the AnalyseSubject function</span>
0025         <a name="_sub0" href="#_subfunctions" class="code">function analyse(self,data,config,eegDevice,edaDevice,hrvDevice)</a>
0026             subjects = data.subjects;
0027             StimuIntDefs = data.stimuIntDefs;
0028             validSubjects = self.countValidSubjects(subjects);
0029             message = [<span class="string">'Analysing data for '</span> num2str(validSubjects) <span class="string">' valid subject(s)'</span>];
0030             wBar = waitbar(0,message);
0031             
0032             <span class="comment">% Tabel with in/valid Status of Subjects</span>
0033             self.subjectValid(subjects,config);
0034                         
0035             <span class="comment">% plot the a file as pdf containing all the GUI and all DEVICE settings</span>
0036             self.plotter.writeSettings(config,eegDevice,edaDevice,hrvDevice,[config.OutputDirectory,<span class="string">'/Settings.pdf'</span>]); 
0037             
0038             <span class="comment">% plot the a file as pdf containing all the ADIndex settings</span>
0039             self.plotter.writeAdIndex(StimuIntDefs,[config.OutputDirectory,<span class="string">'/AdIndex.pdf'</span>]);
0040             
0041             <span class="keyword">for</span> i=1:length(subjects)
0042                 self.frequencies = cell(6,6);
0043                 self.frequencies4Hz = cell(6,6);
0044                 subject = subjects{i};
0045                 <span class="keyword">if</span> subject.isValid == 1 <span class="comment">% Filter invalid subjects</span>
0046                     self.analyseSubject(subject,StimuIntDefs,config,eegDevice,edaDevice,hrvDevice);
0047                 <span class="keyword">end</span>
0048                 waitbar(i/validSubjects);
0049                 fprintf(<span class="string">'\n'</span>);
0050             <span class="keyword">end</span>
0051             close(wBar);
0052         <span class="keyword">end</span>
0053     <span class="keyword">end</span>
0054     methods(Access=private)
0055         <span class="comment">%% Counts valid subjects</span>
0056         <span class="comment">%   subjects: subject class with all nessesary information</span>
0057         <a name="_sub1" href="#_subfunctions" class="code">function numValidSubjects = countValidSubjects(self,subjects)</a>
0058             numValidSubjects=0;
0059             <span class="keyword">for</span> i=1:length(subjects)
0060                 <span class="keyword">if</span> (subjects{i}.isValid)
0061                     numValidSubjects = numValidSubjects+1;
0062                 <span class="keyword">end</span>
0063             <span class="keyword">end</span>
0064         <span class="keyword">end</span>
0065         
0066         <span class="comment">%% Print in/valid subject table</span>
0067         <a name="_sub2" href="#_subfunctions" class="code">function subjectValid(self,subject,config)</a>
0068             numSubjects = length(subject);
0069             validString = cell(length(subject)+3,1); <span class="comment">% +3 for Header</span>
0070             validString(1) = {<span class="string">'Overview of subjects and their EEG status'</span>};
0071             
0072             j = 1;
0073             isValid = 0;
0074             <span class="comment">% loop to check if subject is in/valid</span>
0075             <span class="keyword">for</span> i=1:numSubjects 
0076                sub = subject{i};
0077                <span class="keyword">if</span> sub.isValid == 1
0078                    isValid = isValid+1;
0079                    <span class="comment">% save subject as valid</span>
0080                    validString(i+3) = {[<span class="string">'EEG Values for subject   |   '</span> sub.name <span class="string">'   |   valid'</span>]};
0081                    j = j+1;
0082                    <span class="comment">% check for invalid electrodes and save them behind the</span>
0083                    <span class="comment">% subject</span>
0084                    <span class="keyword">if</span>  ~isempty(sub.invalidElectrodes)
0085                        validString(i+3) = strcat(validString(i+3),<span class="string">'  |  Invalid electrodes  |'</span>,{<span class="string">' '</span>});
0086                        <span class="keyword">for</span> j = 1:length(sub.invalidElectrodes)
0087                        validString(i+3) = strcat(validString(i+3),{<span class="string">' '</span>},sub.invalidElectrodes(j)); 
0088                        <span class="keyword">end</span>
0089                    <span class="keyword">end</span>
0090                <span class="keyword">else</span> 
0091                    <span class="comment">% save subject as invalid</span>
0092                    validString(i+3) = {[<span class="string">'EEG Values for subject   |   '</span> sub.name <span class="string">'   |   invalid'</span>]};
0093                    isValid = isValid + 0;
0094                    <span class="keyword">if</span>  length(sub.invalidElectrodes) &gt;= 1 
0095                        validString(i+3) = strcat(validString(i+3),<span class="string">'  |  Invalid electrodes  |'</span>,{<span class="string">' '</span>});
0096                        <span class="keyword">for</span> j = 1:length(sub.invalidElectrodes)
0097                        validString(i+3) = strcat(validString(i+3),{<span class="string">' '</span>},sub.invalidElectrodes(j)); 
0098                        <span class="keyword">end</span>   
0099                    <span class="keyword">end</span>
0100                <span class="keyword">end</span>
0101             <span class="keyword">end</span>
0102             <span class="comment">% Add string with summary of the subject table</span>
0103             validString(2) = {[num2str(num2str(isValid)) <span class="string">' of '</span> num2str(numSubjects) <span class="string">' subjects are valid'</span>]};
0104             self.plotter.writeValid(validString,[config.OutputDirectory <span class="string">'/'</span> <span class="string">'Subject_Valid_Overview.pdf'</span>]);
0105             
0106             <span class="keyword">if</span> isValid == 0
0107                 fprintf(<span class="string">'\n\nNo valid subject found!\n\n'</span>);
0108             <span class="keyword">end</span>
0109         <span class="keyword">end</span>
0110         
0111         <span class="comment">%% Performs analysis of the data of each subject</span>
0112         <span class="comment">% Main function of the AdAnalyser</span>
0113         <span class="comment">%   subject: information about the current subject</span>
0114         <span class="comment">%   StimuIntDefs: information about all Stimulus Intervals</span>
0115         <span class="comment">%   config: information on the choosen config of the user</span>
0116         <span class="comment">%   devices: information of the used devices</span>
0117         <a name="_sub3" href="#_subfunctions" class="code">function analyseSubject(self,subject,StimuIntDefs,config,eegDevice,edaDevice,hrvDevice)</a>
0118             edaPerStim = subject.edaPerVid;
0119             edaComplete = subject.edaValues;
0120             numStimuInt = length(edaPerStim);
0121             
0122             <span class="comment">% Plot eda values</span>
0123             <span class="keyword">if</span> (config.EDA_DEVICE_USED)
0124                 self.plotter.plotEDA(StimuIntDefs,[subject.OutputDirectory,<span class="string">'/'</span> subject.name <span class="string">'_EDA'</span>,<span class="string">'.pdf'</span>],edaComplete,0);
0125             <span class="keyword">end</span>
0126             
0127             <span class="comment">% Plot eda detrended</span>
0128             <span class="keyword">if</span> (config.DetrendedEDAFig)
0129                 self.plotter.plotEDA(StimuIntDefs,[subject.OutputDirectory,<span class="string">'/'</span> subject.name <span class="string">'_EDA_detrend'</span>,<span class="string">'.pdf'</span>],detrend(edaComplete),1);
0130             <span class="keyword">end</span>
0131             
0132             <span class="comment">% Plot EEG</span>
0133             numElectrodes = length(subject.eegValuesForElectrodes); 
0134             statsMat = cell(4+numElectrodes,9);
0135             <span class="comment">% Mark unvalid subjects in EEG Statistics</span>
0136             <span class="keyword">if</span> subject.isValid == 1
0137                 statsMat(1,1) = {[<span class="string">'Statistics for subject '</span> subject.name]};
0138             <span class="keyword">elseif</span> subject.isValid == 0
0139                 statsMat(1,1) = {[<span class="string">'Statistics for subject '</span> subject.name <span class="string">' EEG VALUES INVALID'</span>]};
0140             <span class="keyword">end</span>
0141             statsMat(3,1:5) ={<span class="string">'EEG values by electrodes'</span>,<span class="string">'mean[µV]'</span>,<span class="string">'sd[µV]'</span>,<span class="string">'dev-[µV]'</span>,<span class="string">'dev+[µV]'</span>};
0142             mMean =0; 
0143             sdMean =0;
0144             devPMean = 0; 
0145             devMMean =0; 
0146             <span class="comment">% create data for each electrode and save in stats matrix</span>
0147             <span class="keyword">for</span> i=1:numElectrodes
0148                 electrodeData = subject.eegValuesForElectrodes{i}; 
0149                 filteredEEGPerVid = electrodeData.filteredEEGPerVid;
0150                 eegComplete = double(electrodeData.eegValues');
0151                 electrode = electrodeData.electrode; 
0152                 <span class="comment">% Calculate statitics for all eeg values</span>
0153                 [m,sd,devP,devM] = self.calculateStatistics(eegComplete);
0154                 mMean = mMean+m; 
0155                 sdMean = sdMean+sd; 
0156                 devPMean = devPMean+devP;
0157                 devMMean = devMMean+devM;
0158                 statsMat(3+i,1:5) = {[char(electrode) <span class="string">': '</span>],num2str(m,<span class="string">'%6.4f'</span>),num2str(sd,<span class="string">'%6.4f'</span>),num2str(devM,<span class="string">'%6.4f'</span>),num2str(devP,<span class="string">'%6.4f'</span>)};
0159             <span class="keyword">end</span>
0160             statsMat(<span class="keyword">end</span>,1:5) = {<span class="string">'Mean electrode values: '</span>,num2str(mMean/numElectrodes,<span class="string">'%6.4f'</span>),num2str(sdMean/numElectrodes,<span class="string">'%6.4f'</span>),num2str(devMMean/numElectrodes,<span class="string">'%6.4f'</span>),num2str(devPMean/numElectrodes,<span class="string">'%6.4f'</span>)}; 
0161             <span class="keyword">for</span> StimuIntNumber=1:numStimuInt
0162                 filteredEEGPerVid = self.calculateMeanEEGValuesForStimuInt(subject);
0163                 StimuIntStatsMat = self.analyseStimuInt(subject,StimuIntNumber,filteredEEGPerVid,edaPerStim,StimuIntDefs,config,eegDevice,edaDevice,hrvDevice);
0164                 statsMat = vertcat(statsMat,StimuIntStatsMat);
0165             <span class="keyword">end</span>
0166             
0167             <span class="comment">% EDA statistics</span>
0168             <span class="comment">% get index of Stimulus Type 1 - see StimuIntDefinition.m</span>
0169             orientingResponseIndex = self.getStimuIntIndex(1,StimuIntDefs);
0170             [amplitudes,delays] = self.calculateDelaysEDA(edaPerStim{orientingResponseIndex},StimuIntDefs{orientingResponseIndex}.intervals,edaDevice);
0171             <span class="comment">% get index of Stimlus Type 0, 1, 4, 5 and 6 - see StimuIntDefinition.m</span>
0172             edaStimuInt = self.getStimuIntIndex([0,1,4,5,6],StimuIntDefs);
0173             <span class="comment">% create EDA stats matrix</span>
0174             edaStatsMat = self.calculateEDAStatistics(edaStimuInt,edaPerStim,delays,amplitudes,StimuIntDefs);
0175             edaStatsMat = vertcat({<span class="string">'EDA statistics'</span>,<span class="string">''</span>,<span class="string">''</span>,<span class="string">''</span>,<span class="string">''</span>,<span class="string">''</span>,<span class="string">''</span>,<span class="string">''</span>,<span class="string">''</span>},edaStatsMat);
0176             edaStatsString =   self.stringStatistics.matrixToString(edaStatsMat(1:end-2,:),<span class="string">' | '</span>);
0177             delayString =  self.stringStatistics.delaysToString(edaStatsMat(end-1,:));
0178             ampString =  self.stringStatistics.aplitudesToString(edaStatsMat(<span class="keyword">end</span>,:));
0179             statsMat = vertcat(statsMat,edaStatsMat);
0180             statString =  self.stringStatistics.matrixToString(statsMat(1:end-2,:),<span class="string">' | '</span>);
0181             
0182             <span class="comment">% Plot statistics</span>
0183             <span class="keyword">if</span> (config.Statistics)
0184                 <span class="comment">% save statistics as pdf and CSV</span>
0185                 self.plotter.writeCSV([subject.OutputDirectory <span class="string">'/'</span> subject.name <span class="string">'_statistics.csv'</span>],<span class="string">'%s;%s;%s;%s;%s;%s;%s;%s;%s\n'</span>,statsMat');
0186                 self.plotter.writeStatistics([statString newline newline delayString newline ampString],[subject.OutputDirectory <span class="string">'/'</span> subject.name <span class="string">'_statistics.pdf'</span>]);
0187             <span class="keyword">end</span>
0188             
0189             <span class="comment">% create data for EEG Topology plots, if necessary</span>
0190             <span class="keyword">if</span> config.topoplot == 1 || config.brainactivity == 1
0191                 <span class="comment">% Preparing EEG Data for print</span>
0192                 <span class="comment">% Import of Standard 10-20 System channel locs for electrodes</span>
0193                 load Standard-10-20-Cap81.mat;
0194 
0195                 <span class="comment">% Data preparation</span>
0196                 Usedelectrodes = subject.Electrodes;
0197                 numValues = subject.eegValuesForElectrodes; 
0198                 numElectrodes = length(numValues);
0199                 <span class="keyword">for</span> i = 1:numElectrodes              
0200                     eegValues(:,i) =  subject.eegValuesForElectrodes{1, i}.eegValues;              
0201                 <span class="keyword">end</span>
0202                 PlotDataOverTime = eegValues';
0203 
0204                 <span class="comment">% needed variables for chanloc preparation</span>
0205                 chanloc = Chanloc; <span class="comment">% get Chanloc included in Standard-10-20-Cap81.mat</span>
0206                 electrodes = Usedelectrodes'; <span class="comment">% transfrom vector</span>
0207                 numUsedElectrodes = length(electrodes);
0208                 lengthStandardChanloc = length(Chanloc);
0209                 deleteRow = zeros(1,lengthStandardChanloc);
0210                 SumDeleteRow = zeros(1,lengthStandardChanloc);
0211 
0212                 <span class="comment">% delete all unused electrode chanlocs</span>
0213                 <span class="keyword">for</span> i = 1:numUsedElectrodes
0214                     deleteRow = ismember({chanloc.labels}, electrodes{i});
0215                     SumDeleteRow = SumDeleteRow + deleteRow;
0216                 <span class="keyword">end</span>
0217                 SumDeleteRow = ~SumDeleteRow;
0218                 <span class="comment">% delete the unused rows</span>
0219                 chanloc(SumDeleteRow) = [];
0220 
0221                 <span class="comment">% Create EEG Structur which is used in Topology plot of</span>
0222                 <span class="comment">% EEGLab libary</span>
0223                 EEG.data = PlotDataOverTime;        <span class="comment">% data array (chans x frames x epochs)</span>
0224                 EEG.setname = subject.name;         <span class="comment">% Set name = Number of subject</span>
0225                 EEG.chanlocs = chanloc;             <span class="comment">% name of file containing names and positions of the channels on the scalp</span>
0226                 EEG.nbchan = length(EEG.chanlocs);  <span class="comment">% number of channels in each epoch</span>
0227                 EEG.pnts = length(EEG.data);        <span class="comment">% number of frames (time points) per epoch (trial)</span>
0228                 EEG.trials = 1;                     <span class="comment">% number of epochs (trials) in the dataset (Allways 1 for now)</span>
0229                 EEG.srate = eegDevice.samplingRate; <span class="comment">% sampling rate (in Hz)</span>
0230                 EEG.xmin = 0;                       <span class="comment">% epoch start time (in seconds)</span>
0231                 EEG.xmax = (EEG.pnts-1)/EEG.srate;  <span class="comment">% epoch end time (in seconds)</span>
0232             <span class="keyword">end</span>
0233                         
0234             <span class="comment">% Plot 2D Topology Map</span>
0235             <span class="keyword">if</span> config.topoplot == 1 
0236                 self.plotter.printTopo(config,subject,EEG,StimuIntDefs,electrodes);
0237             <span class="keyword">end</span>
0238             
0239             <span class="comment">% Plot Brain Activity Plot</span>
0240             <span class="keyword">if</span> config.brainactivity == 1
0241                 self.plotter.stimulusOverviewChart(config,subject,EEG,StimuIntDefs);
0242             <span class="keyword">end</span>
0243             
0244             <span class="comment">% Plot subStimuIntEDA</span>
0245             <span class="keyword">if</span> (config.SubStimuIntEDAFig)
0246                 self.plotter.plotSubStimuIntEDA(edaStimuInt,edaPerStim,StimuIntDefs,subject.name,[subject.OutputDirectory <span class="string">'/'</span> subject.name <span class="string">' EDA_Values_for_all_StimulusInterval(s)'</span>],[edaStatsString newline newline delayString newline ampString]);
0247             <span class="keyword">end</span>
0248             
0249             <span class="comment">% Plot HRV figure</span>
0250             <span class="keyword">if</span> (config.HRV_DEVICE_USED)
0251                 self.plotter.plotHRV(subject.hrvValues,subject.OutputDirectory,subject.name,StimuIntDefs);
0252             <span class="keyword">end</span>
0253             
0254             <span class="comment">% Plot HRV Recurrence</span>
0255             <span class="keyword">if</span> (config.RecurrenceFig)
0256                 self.plotter.plotHRVRecurrence(subject,config,<span class="string">'HRV'</span>,subject.hrvValues,StimuIntDefs);
0257             <span class="keyword">end</span>
0258             
0259             <span class="comment">% plot frequencies for baseline Stimulus Intervals with baseline magnitude</span>
0260             <span class="keyword">if</span> (config.FrequencyFig)
0261                 <span class="comment">% get Stimulus Interval Types</span>
0262                 <span class="keyword">for</span> i = 1:length(StimuIntDefs)
0263                     StimuIntTypes(i) = StimuIntDefs{1, i}.stimuIntType;
0264                 <span class="keyword">end</span>
0265                 
0266                 <span class="comment">% get frequencie for baseline</span>
0267                 BaselineIndex = find(StimuIntTypes == 2); <span class="comment">% Type 2 = EEG Baseline</span>
0268                 [~,baselineTheta_s,baselineAlpha_s,baselineBeta1_s,baselineBeta2_s,baselineTEI_s] = self.frequencies4Hz{BaselineIndex,:};
0269                 
0270                 <span class="comment">% get all indices for Stimulus &gt;= 4</span>
0271                 <span class="comment">% see StimuIntDefinition.m</span>
0272                 StimulIndex = find(StimuIntTypes &gt;= 4);
0273                 
0274                 <span class="comment">% plot frequencies for all Stimuli</span>
0275                 <span class="keyword">for</span> i = StimulIndex    
0276                     [~,StimuIntTheta_s,StimuIntAlpha_s,StimuIntBeta1_s,StimuIntBeta2_s,StimuIntTEI_s] = self.frequencies4Hz{i,:};
0277                     resolution = i;
0278                     intervals = StimuIntDefs{i}.intervals;
0279                     StimuIntDescrp = StimuIntDefs{i}.stimuIntDescrp;
0280                     
0281                     self.plotter.plotFrequencysWithBaselineMagnitude(length(filteredEEGPerVid{i})/eegDevice.samplingRate,<span class="keyword">...</span>
0282                         [subject.OutputDirectory <span class="string">'/'</span> subject.name <span class="string">'_alpha_beta_theta_TEI_'</span> StimuIntDescrp <span class="string">'.pdf'</span>],<span class="keyword">...</span>
0283                         StimuIntTheta_s,StimuIntAlpha_s,StimuIntBeta1_s,StimuIntBeta2_s,StimuIntTEI_s,baselineTheta_s,<span class="keyword">...</span>
0284                         baselineAlpha_s,baselineBeta1_s,baselineBeta2_s,baselineTEI_s,resolution,intervals,<span class="keyword">...</span>
0285                         [<span class="string">'Theta, Alpha, Beta1, Beta2 frequencies and TEI for '</span> StimuIntDescrp <span class="string">' of subject '</span> subject.name]);
0286                 <span class="keyword">end</span>
0287             <span class="keyword">end</span>
0288             <span class="comment">% transient = self.frequencyEstimation(edaComplete); obsolet</span>
0289             <span class="comment">% self.plotter.plotMomentaryFrequency(transient,config,subject,stimuIntDef)</span>
0290             
0291         <span class="keyword">end</span>
0292         
0293         <span class="comment">% Calcualtes the mean Value of the EEG for each Stimulus/Subject</span>
0294         <a name="_sub4" href="#_subfunctions" class="code">function meanEEGPerStim = calculateMeanEEGValuesForStimuInt(self,subject)</a>
0295             numElectrodes = length(subject.eegValuesForElectrodes);
0296             eegForElectrode = subject.eegValuesForElectrodes{1};
0297             numStimuInt = length(eegForElectrode.filteredEEGPerVid);
0298             meanEEGPerStim = cell(1,numStimuInt);
0299             <span class="comment">% cycle through Simulus Intervals and electrodes</span>
0300             <span class="keyword">for</span> i = 1:numStimuInt
0301                 meanEEGPerStim{i} = eegForElectrode.filteredEEGPerVid{i};
0302                 <span class="keyword">for</span> j = 2:numElectrodes
0303                     valuesForElectrode = subject.eegValuesForElectrodes{j}.filteredEEGPerVid{i}; 
0304                     previousValues = meanEEGPerStim{i}; 
0305                     meanEEGPerStim{i} = previousValues+valuesForElectrode;
0306                 <span class="keyword">end</span>
0307                 numValues = length(meanEEGPerStim{i});
0308                 <span class="keyword">for</span> j = 1:numValues
0309                     meanEEGPerStim{i}(j) = meanEEGPerStim{i}(j)/numElectrodes;
0310                 <span class="keyword">end</span>
0311             <span class="keyword">end</span>
0312         <span class="keyword">end</span>
0313         
0314         <span class="comment">%% Performs analysis for each StimulusInterval of each subject</span>
0315         <a name="_sub5" href="#_subfunctions" class="code">function StimuIntStatsMat = analyseStimuInt(self,subject,StimuIntNumber,filteredEEGPerStim,edaPerVid,StimuIntDefs,config,eegDevice,edaDevice,hrvDevice)</a>
0316             <span class="comment">% Calculate eeg statistics for each StimulusInterval</span>
0317             StimuIntLength = length(filteredEEGPerStim{StimuIntNumber})/eegDevice.samplingRate;
0318             StimuIntDef = StimuIntDefs{StimuIntNumber};
0319             StimuIntStatsMat = cell(1,9);
0320             StimuIntStatsMat(1,1) = {[<span class="string">'EEG statistics for '</span> StimuIntDef.stimuIntDescrp]};
0321             [delta,theta,alpha,beta1,beta2,task] = self.analyseFrequencies(filteredEEGPerStim{StimuIntNumber},eegDevice);
0322             self.frequencies(StimuIntNumber,:) = {delta,theta,alpha,beta1,beta2,task};
0323             
0324             <span class="comment">% Calculate eeg statistics for each StimulusInterval and each frequency</span>
0325             eegFreqStatsMat = self.calculateEEGFrequencyStatistics(filteredEEGPerStim{StimuIntNumber},delta,theta,alpha,beta1,beta2,task);
0326             StimuIntStatsMat = vertcat(StimuIntStatsMat,eegFreqStatsMat);
0327             
0328             <span class="comment">% Reduce signal resolution to 4Hz</span>
0329             [delta_s,theta_s,alpha_s,beta1_s,beta2_s,task_s] = self.reduceTo4Hz(delta,theta,alpha,beta1,beta2,task,eegDevice);
0330             self.frequencies4Hz(StimuIntNumber,:) = {delta_s,theta_s,alpha_s,beta1_s,beta2_s,task_s};
0331             
0332             <span class="comment">% plot Behavioral Characteristics</span>
0333             <span class="keyword">if</span>(config.BehaveFig)
0334                 self.plotter.plotBehavioralCharacteristics(subject.name,StimuIntNumber,subject.OutputDirectory,self.frequencies(StimuIntNumber,:),StimuIntDef,eegDevice)
0335             <span class="keyword">end</span>
0336             
0337             <span class="comment">%plot Frequency figure</span>
0338             <span class="keyword">if</span> (config.FrequencyFig)
0339                 resolution = 4;
0340                 self.plotter.plotFrequencys(StimuIntLength,[subject.OutputDirectory <span class="string">'\'</span> subject.name <span class="string">'_freq_bands_'</span> StimuIntDef.stimuIntDescrp],theta_s,alpha_s,beta1_s,beta2_s,task_s,resolution,StimuIntDef,edaPerVid{StimuIntNumber});
0341             <span class="keyword">end</span>
0342             
0343             <span class="comment">% Plot Recurrence</span>
0344             <span class="keyword">if</span> (config.RecurrenceFig)
0345                 <span class="keyword">if</span> StimuIntDef.stimuIntType &gt;= 4 <span class="comment">% Types -&gt; see StimuIntDefinition.m</span>
0346                     self.plotter.plotEDARecurrence(subject,config,StimuIntDef,edaPerVid{StimuIntNumber},edaDevice);
0347                 <span class="keyword">end</span>
0348             <span class="keyword">end</span>
0349         <span class="keyword">end</span>
0350               
0351         <span class="comment">%% Method calculates mean of values and standard derivation, max, min for detrended values</span>
0352         <span class="comment">%   Used to create statistics</span>
0353         <a name="_sub6" href="#_subfunctions" class="code">function [m,sd,devP,devM] = calculateStatistics(self,values)</a>
0354             m = mean(values);
0355             detrended = detrend(values);
0356             sd = std(detrended);
0357             devP = max(detrended);
0358             devM = min(detrended);
0359         <span class="keyword">end</span>
0360         
0361         <span class="comment">%% Calculates staticstics for the different eeg frequencies</span>
0362         <span class="comment">%  creates and returns StatsMat cell array</span>
0363         <a name="_sub7" href="#_subfunctions" class="code">function statsMat = calculateEEGFrequencyStatistics(self,eeg,delta,theta,alpha,beta1,beta2,task)</a>
0364             statsMat = cell(7,9);
0365             [m,sd,devP,devM] = self.calculateStatistics(eeg);
0366             statsMat(1,1:5) = {<span class="string">'EEG'</span>,num2str(m,<span class="string">'%6.4f'</span>),num2str(sd,<span class="string">'%6.4f'</span>),num2str(devM,<span class="string">'%6.4f'</span>),num2str(devP,<span class="string">'%6.4f'</span>)};
0367             [m,sd,devP,devM] = self.calculateStatistics(delta);
0368             statsMat(2,1:5) = {<span class="string">'EEG delta'</span>,num2str(m,<span class="string">'%6.4f'</span>),num2str(sd,<span class="string">'%6.4f'</span>),num2str(devM,<span class="string">'%6.4f'</span>),num2str(devP,<span class="string">'%6.4f'</span>)};
0369             [m,sd,devP,devM] = self.calculateStatistics(theta);
0370             statsMat(3,1:5) = {<span class="string">'EEG theta'</span>,num2str(m,<span class="string">'%6.4f'</span>),num2str(sd,<span class="string">'%6.4f'</span>),num2str(devM,<span class="string">'%6.4f'</span>),num2str(devP,<span class="string">'%6.4f'</span>)};
0371             [m,sd,devP,devM] = self.calculateStatistics(alpha);
0372             statsMat(4,1:5) = {<span class="string">'EEG alpha'</span>,num2str(m,<span class="string">'%6.4f'</span>),num2str(sd,<span class="string">'%6.4f'</span>),num2str(devM,<span class="string">'%6.4f'</span>),num2str(devP,<span class="string">'%6.4f'</span>)};
0373             [m,sd,devP,devM] = self.calculateStatistics(beta1);
0374             statsMat(5,1:5) = {<span class="string">'EEG beta 1'</span>,num2str(m,<span class="string">'%6.4f'</span>),num2str(sd,<span class="string">'%6.4f'</span>),num2str(devM,<span class="string">'%6.4f'</span>),num2str(devP,<span class="string">'%6.4f'</span>)};
0375             [m,sd,devP,devM] = self.calculateStatistics(beta2);
0376             statsMat(6,1:5) = {<span class="string">'EEG beta 2'</span>,num2str(m,<span class="string">'%6.4f'</span>),num2str(sd,<span class="string">'%6.4f'</span>),num2str(devM,<span class="string">'%6.4f'</span>),num2str(devP,<span class="string">'%6.4f'</span>)};
0377             [m,sd,devP,devM] = self.calculateStatistics(task);
0378             statsMat(7,1:5) = {<span class="string">'TEI'</span>,num2str(m,<span class="string">'%6.4f'</span>),num2str(sd,<span class="string">'%6.4f'</span>),num2str(devM,<span class="string">'%6.4f'</span>),num2str(devP,<span class="string">'%6.4f'</span>)};
0379         <span class="keyword">end</span>
0380         
0381         <span class="comment">%% Calculates statistics for eda values including delays (Delta_t) and amplitudes</span>
0382         <span class="comment">%  creates and returns StatsMat cell array % Tim Absprache zu Stats</span>
0383         <a name="_sub8" href="#_subfunctions" class="code">function statsMat = calculateEDAStatistics(self,StimuInt,edaValues,delays,amplitudes,StimuIntDefs)</a>
0384             edaValuesForStimuInt = edaValues(StimuInt);
0385             numEDAStimuInts = length(edaValuesForStimuInt);
0386             <span class="comment">% create EDA cell array for statistics and enter the data into</span>
0387             <span class="comment">% the array</span>
0388             statsMat = cell(numEDAStimuInts+4,9);
0389             statsMat(1,2:5) ={<span class="string">'mean[µS]'</span>,<span class="string">'sd[µS]'</span>,<span class="string">'dev-[µS]'</span>,<span class="string">'dev+[µS]'</span>} ;
0390             completeEDA = cell2mat(edaValues');
0391             [m,sd,devP,devM] = self.calculateStatistics(completeEDA);
0392             statsMat(2,1:5) = {<span class="string">'EDA complete'</span>,num2str(m,<span class="string">'%6.4f'</span>),num2str(sd,<span class="string">'%6.4f'</span>),num2str(devM,<span class="string">'%6.4f'</span>),num2str(devP,<span class="string">'%6.4f'</span>)};
0393             <span class="comment">% get Stimlus Type</span>
0394             <span class="keyword">for</span> i=1:numEDAStimuInts
0395                 StimuIntClass = StimuIntDefs{i};
0396                 [m,sd,devP,devM] = self.calculateStatistics(edaValuesForStimuInt{i});
0397                 statsMat(i+2,1:5) = {StimuIntClass.stimuIntDescrp,num2str(m,<span class="string">'%6.4f'</span>),num2str(sd,<span class="string">'%6.4f'</span>),num2str(devM,<span class="string">'%6.4f'</span>),num2str(devP,<span class="string">'%6.4f'</span>)};
0398             <span class="keyword">end</span>
0399             delaysNotNull = delays(delays~=0);
0400             amplitudesNotNull = amplitudes(amplitudes~=0);
0401             indicies = find(delays);
0402             <span class="keyword">if</span> isempty(delaysNotNull)
0403                 s= <span class="string">'No valid peaks found for Delta_t'</span>;
0404                 statsMat{end-1,1}= s;
0405             <span class="keyword">elseif</span> length(delaysNotNull)==1
0406                 statsMat{end-1,1} = [<span class="string">'Delta_t of EDA Orientation Baseline based on interval '</span> strtrim(num2str(indicies))];
0407                 statsMat{end-1,2} = num2str(delaysNotNull);
0408             <span class="keyword">else</span>
0409                 delayMean = mean(delaysNotNull);
0410                 delayVar = var(delaysNotNull);
0411                 minVarDelay = delayMean - min(delaysNotNull);
0412                 maxVarDelay = max(delaysNotNull) - delayMean;
0413                 statsMat(end-1,1:5) = {
0414                     [<span class="string">'Delta_t EDA Orientation Baseline for intervals '</span> strtrim(strrep(num2str(indicies),<span class="string">'  '</span>,<span class="string">','</span>))],<span class="keyword">...</span>
0415                     [<span class="string">'mean='</span> num2str(delayMean,<span class="string">'%6.2f'</span>) <span class="string">'s'</span>],[<span class="string">'var='</span> num2str(delayVar,<span class="string">'%6.2f'</span>) <span class="string">'s'</span>],<span class="keyword">...</span>
0416                     [<span class="string">'dev+='</span> num2str(minVarDelay,<span class="string">'%6.2f'</span>) <span class="string">'s'</span>],[<span class="string">'dev-='</span> num2str(maxVarDelay,<span class="string">'%6.2f'</span>) <span class="string">'s'</span>]
0417                     };
0418                 numAmplitudes = length(amplitudesNotNull);
0419                 amplitudesAsString = cell(1,numAmplitudes+1);
0420                 amplitudesAsString(1,1) = {[<span class="string">'Amplitudes for intervals '</span> strtrim(strrep(num2str(indicies),<span class="string">'  '</span>,<span class="string">','</span>))]};
0421                 <span class="keyword">for</span> i=1:numAmplitudes
0422                     amplitudesAsString(1,i+1) = {[num2str(amplitudesNotNull(i),<span class="string">'%6.2f'</span>) <span class="string">'µS'</span>]};
0423                 <span class="keyword">end</span>
0424                 statsMat(<span class="keyword">end</span>,1:length(amplitudesAsString)) = amplitudesAsString;
0425             <span class="keyword">end</span>
0426         <span class="keyword">end</span>
0427         
0428         <span class="comment">%% Calculates eda delays for given intervals</span>
0429         <a name="_sub9" href="#_subfunctions" class="code">function [values,delays] = calculateDelaysEDA(self,edaValues,intervals,edaDevice)</a>
0430             edaValuesDetrend = detrend(edaValues);
0431             numEDAValues = length(edaValuesDetrend);
0432             edaPerSec = edaDevice.samplingRate;
0433             intervals(end+1)= numEDAValues/edaPerSec;
0434             start = uint32(intervals(1)*1);
0435             ende = uint32((intervals(2)+5)*1); <span class="comment">% end offset (project in next interval)</span>
0436             offset = 1; <span class="comment">% start offset (start 5 datapoints later from interval start)</span>
0437             valuesBetweenIntervals = edaValuesDetrend(start+offset:ende);
0438             m = mean (smooth(valuesBetweenIntervals));
0439             delays = zeros(1,length(intervals));
0440             values = zeros(1,length(intervals));
0441             [peak,index] = findpeaks(smooth(valuesBetweenIntervals),<span class="string">'MINPEAKDISTANCE'</span>,5,<span class="string">'MINPEAKHEIGHT'</span>,(m*120)/100);
0442             <span class="keyword">if</span> length(index)&gt;1
0443                 index = index(1); <span class="comment">% find(peak == max(peak))</span>
0444             <span class="keyword">end</span>
0445             <span class="keyword">if</span> length(index)~=1 || max(peak) &lt; 0
0446                 delays(1) = 0;
0447                 values(1) =0;
0448             <span class="keyword">else</span>
0449                 pos = start+offset+index;
0450                 delays(1) = double(pos-(intervals(1)*edaPerSec))/edaPerSec;
0451                 values(1) = edaValues(pos);
0452             <span class="keyword">end</span>
0453         <span class="keyword">end</span>
0454         
0455         <span class="comment">%% Splits eeg data into different frequencies</span>
0456         <a name="_sub10" href="#_subfunctions" class="code">function [delta,theta,alpha,beta1,beta2,task] = analyseFrequencies(self,filteredEEGData,eegDevice)</a>
0457             EEGsampRate=eegDevice.samplingRate;
0458             <span class="comment">%--------------------- Delta (1-4 Hz)</span>
0459             delta = sqrt((eegfiltfft(filteredEEGData,EEGsampRate,1,4)).^2);
0460             <span class="comment">%--------------------- Theta(5-7 Hz)</span>
0461             theta = sqrt((eegfiltfft(filteredEEGData,EEGsampRate,5,7)).^2);
0462             <span class="comment">%--------------------- Alpha(8-13 Hz)</span>
0463             alpha = sqrt((eegfiltfft(filteredEEGData,EEGsampRate,8,13)).^2);
0464             <span class="comment">%--------------------- Beta1(14-24 Hz)</span>
0465             beta1 = sqrt((eegfiltfft(filteredEEGData,EEGsampRate,14,24)).^2);
0466             <span class="comment">%--------------------- Beta2(25-40 Hz)</span>
0467             beta2 = sqrt((eegfiltfft(filteredEEGData,EEGsampRate,25,40)).^2);
0468             <span class="comment">%--------------------- Task-Engagement</span>
0469             task = beta1./(alpha+theta);
0470         <span class="keyword">end</span>
0471         
0472         <span class="comment">%% Subsamples the different eeg frequencies to a resoultion of 4Hz</span>
0473         <a name="_sub11" href="#_subfunctions" class="code">function [delta_s,theta_s,alpha_s,beta1_s,beta2_s,task_s] = reduceTo4Hz(self,delta,theta,alpha,beta1,beta2,task,eegDevice)</a>
0474             resolution = 4;
0475             resolutionFac = double(eegDevice.samplingRate/resolution);
0476             l = length(delta)/(resolutionFac);
0477             delta_s = zeros(1,l);
0478             theta_s = zeros(1,l);
0479             alpha_s = zeros(1,l);
0480             beta1_s= zeros(1,l);
0481             beta2_s= zeros(1,l);
0482             task_s= zeros(1,l);
0483             <span class="keyword">for</span> i = 1:l
0484                 <span class="comment">% Build mean value between upper and lower bound for each frequency in order to</span>
0485                 <span class="comment">% reduce the signal resolution</span>
0486                 lower = (i-1)*(resolutionFac)+1;
0487                 upper = (i-1)*(resolutionFac)+(resolutionFac);
0488                 delta_s(i) = mean(delta(lower:upper));
0489                 theta_s(i) = mean(theta(lower:upper));
0490                 alpha_s(i) = mean(alpha(lower:upper));
0491                 beta1_s(i) = mean(beta1(lower:upper));
0492                 beta2_s(i) = mean(beta2(lower:upper));
0493                 task_s(i) = mean(task(lower:upper));
0494             <span class="keyword">end</span>
0495         <span class="keyword">end</span>
0496         
0497         
0498         <span class="comment">%% Function which returns the indices of the stimlus interval of a given type</span>
0499         <span class="comment">%  see StimuIntDefinition.m for more information about the Stimlus</span>
0500         <span class="comment">%  types</span>
0501         <a name="_sub12" href="#_subfunctions" class="code">function indicies = getStimuIntIndex(self,SearchType,StimuIntDef)</a>
0502             lengthStimu = length(StimuIntDef);
0503             indicies = zeros(1,lengthStimu);
0504 
0505             <span class="keyword">for</span> i = 1:lengthStimu
0506                 StimuIntType = StimuIntDef{i}.stimuIntType;
0507                 <span class="keyword">for</span> j = 1:length(SearchType)
0508                     <span class="keyword">if</span> StimuIntType == SearchType(j)
0509                         indicies(i)= i;    
0510                     <span class="keyword">end</span>
0511                 <span class="keyword">end</span> 
0512             <span class="keyword">end</span>
0513             indicies = indicies(indicies~=0);
0514         <span class="keyword">end</span>
0515         
0516         
0517         
0518     <span class="keyword">end</span>
0519 <span class="keyword">end</span>
0520</pre></div>
<hr><address>Generated on Tue 12-Jan-2021 15:39:55 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" target="_parent">m2html</a></strong> &copy; 2005</address>
</body>
</html>